name: Build Jupii Stable (Latest Tag) on Copr

on:
  push:
    tags:
      - '*'
  schedule:
    - cron: "0 0 * * *" 
  workflow_dispatch:

jobs:
  build-and-copr:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    env:
      COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
      COPR_USER: ${{ secrets.COPR_USER }}
      COPR_TOKEN: ${{ secrets.COPR_TOKEN }}

    steps:
      - name: Install dependencies
        run: |
          dnf install -y git rpm-build rpmdevtools python3-pip python3-requests python3-requests-gssapi copr-cli curl jq

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          
      - name: Check for New Tag
        id: check_tag
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          MY_CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          git remote add upstream https://github.com/mkiol/Jupii || true
          git fetch upstream --tags
          git fetch origin --tags
          LATEST_UPSTREAM_TAG=$(git describe --tags $(git rev-list --tags --max-count=1 --remotes=upstream))          
          LATEST_MY_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) || echo "none")
          echo "Upstream Tag: $LATEST_UPSTREAM_TAG"
          echo "My Last Tag: $LATEST_MY_TAG"
          if [ "$LATEST_UPSTREAM_TAG" = "$LATEST_MY_TAG" ]; then
            echo "Result: No new version. Skipping build."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "Result: New version detected ($LATEST_UPSTREAM_TAG)!"
            git checkout $LATEST_UPSTREAM_TAG
            git checkout $MY_CURRENT_BRANCH -- jupii.spec
            echo "LATEST_TAG=$LATEST_UPSTREAM_TAG" >> $GITHUB_ENV
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Build and Submit to Copr
        if: steps.check_tag.outputs.updated == 'true'
        run: |
          rpmdev-setuptree
          VERSION_CLEAN=$(echo ${{ env.LATEST_TAG }} | sed 's/^v//' | tr '-' '.')
          echo "Cleaned Version: $VERSION_CLEAN"
          sed -i "s/^Version:.*/Version: $VERSION_CLEAN/" jupii.spec
          sed -i "s/^Release:.*/Release: 1%{?dist}/" jupii.spec
          git archive --format=tar.gz --prefix=Jupii/ -o ~/rpmbuild/SOURCES/Jupii.tar.gz HEAD
          cp jupii.spec ~/rpmbuild/SPECS/
          rpmbuild -bs ~/rpmbuild/SPECS/jupii.spec
          mkdir -p ~/.config
          cat <<EOF > ~/.config/copr
          [copr-cli]
          login = $COPR_LOGIN
          username = $COPR_USER
          token = $COPR_TOKEN
          copr_url = https://copr.fedorainfracloud.org
          EOF
          copr-cli build $COPR_USER/jupii ~/rpmbuild/SRPMS/*.src.rpm

      - name: Sync Tag to My Repo
        if: steps.check_tag.outputs.updated == 'true'
        run: |
          git tag ${{ env.LATEST_TAG }} || true
          git push origin ${{ env.LATEST_TAG }}
